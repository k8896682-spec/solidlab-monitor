<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solid Lab inc. | IMM Tracking</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>

    <header>
        <h1>Solid Lab inc. <span>IMM Tracking</span></h1>
    </header>

    <main class="container">
        <section class="map-section">
            <div class="section-label">MAP VIEW</div>
            <div class="japan-map-container">
                <img src="{{ url_for('static', filename='japan_map.svg') }}" alt="Japan Map" class="japan-map-img">

                <div id="marker-a" class="equipment-marker" data-target="detail-a" style="top: 42%; left: 44%;"></div>
                <div id="marker-b" class="equipment-marker" data-target="detail-b" style="top: 40%; left: 44.5%;"></div>
                <div id="marker-c" class="equipment-marker" data-target="detail-c" style="top: 45%; left: 42%;"></div>

                <svg id="connecting-rods-svg"></svg>
            </div>
        </section>

        <section class="content-section">
            <div class="section-label">UNIT DETAILS</div>
            
            <div id="initial-message" class="detail-box active">
                <h3>SELECT UNIT</h3>
                <p>マップ上のマーカーを選択してください。ThingSpeakの最新データがスライド表示されます。</p>
            </div>

            <div id="detail-a" class="detail-box">
                <div class="unit-header">
                    <span class="status-tag">LOADING...</span>
                    <h3>UNIT 01A</h3>
                </div>
                <div class="data-grid">
                    <p><strong>拠点</strong> <span>tonakan1</span></p>
                    <p><strong>場所</strong> <span>福井県福井市</span></p>
                    <p><strong>稼働状態</strong> <span class="val-status">--</span></p>
                    <p><strong>電源投入回数</strong> <span class="val-count">--</span></p>
                    <p><strong>温度データ</strong> <span class="val-temp">--.-℃</span></p>
                </div>
            </div>

            <div id="detail-b" class="detail-box">
                <div class="unit-header">
                    <span class="status-tag">LOADING...</span>
                    <h3>UNIT 02B</h3>
                </div>
                <div class="data-grid">
                    <p><strong>拠点</strong> <span>tonakan2</span></p>
                    <p><strong>場所</strong> <span>福井県福井市</span></p>
                    <p><strong>稼働状態</strong> <span class="val-status">--</span></p>
                    <p><strong>電源投入回数</strong> <span class="val-count">--</span></p>
                    <p><strong>温度データ</strong> <span class="val-temp">--.-℃</span></p>
                </div>
            </div>
        </section>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const markers = document.querySelectorAll('.equipment-marker');
            const detailBoxes = document.querySelectorAll('.detail-box');
            const svg = document.getElementById('connecting-rods-svg');
            const mapContainer = document.querySelector('.japan-map-container');

            const deviceMapping = {
                "detail-a": { channelId: "2984916", readKey: "H8F1OIM9U1NLQE3M" },
                "detail-b": { channelId: "2874643", readKey: "3L8GCQ6QQRJD9R2R" }
            };

            markers.forEach(marker => {
                marker.addEventListener('click', async () => {
                    const targetId = marker.getAttribute('data-target');
                    const targetDetail = document.getElementById(targetId);

                    // 1. 即時リセット
                    detailBoxes.forEach(box => {
                        box.style.transition = 'none';
                        box.classList.remove('active');
                        box.style.display = 'none';
                    });
                    svg.innerHTML = '';

                    // 2. データ取得
                    if (deviceMapping[targetId]) {
                        await updateDeviceData(targetId);
                    }

                    // 3. スライドイン表示（スマホ時は少し待ち時間を調整）
                    if (targetDetail) {
                        setTimeout(() => {
                            targetDetail.style.display = 'block';
                            targetDetail.style.transition = '';
                            requestAnimationFrame(() => {
                                targetDetail.classList.add('active');
                                drawConnectingRods(marker, targetDetail);
                            });
                        }, 200);
                    }
                });
            });

            async function updateDeviceData(targetId) {
                const config = deviceMapping[targetId];
                const url = `https://api.thingspeak.com/channels/${config.channelId}/feeds.json?api_key=${config.readKey}&results=100`;
                const box = document.getElementById(targetId);
                try {
                    const res = await fetch(url);
                    const data = await res.json();
                    const latest = data.feeds[data.feeds.length - 1];
                    if (!latest) return;

                    const isOnline = latest.field2 === "1";
                    box.querySelector('.status-tag').textContent = isOnline ? "ONLINE" : "OFFLINE";
                    box.querySelector('.status-tag').className = `status-tag ${isOnline ? 'online' : 'offline'}`;
                    box.querySelector('.val-status').textContent = isOnline ? "稼働中" : "停止中";
                    box.querySelector('.val-count').textContent = latest.field3 || "0";
                    box.querySelector('.val-temp').textContent = (latest.field1 ? parseFloat(latest.field1).toFixed(1) : "--.-") + "℃";
                } catch (e) { console.error(e); }
            }

            function drawConnectingRods(activeMarker, activeDetail) {
                svg.innerHTML = '';
                const mapRect = mapContainer.getBoundingClientRect();
                const markerRect = activeMarker.getBoundingClientRect();
                const detailRect = activeDetail.getBoundingClientRect();

                const startX = markerRect.left + markerRect.width / 2 - mapRect.left;
                const startY = markerRect.top + markerRect.height / 2 - mapRect.top;

                // PCなら詳細の左側へ、スマホなら詳細の上側へ線を引く
                const isMobile = window.innerWidth <= 768;
                const endX = isMobile ? startX : (detailRect.left - mapRect.left);
                const endY = isMobile ? (detailRect.top - mapRect.top) : (detailRect.top + 45 - mapRect.top);

                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('x1', startX); line.setAttribute('y1', startY);
                line.setAttribute('x2', endX); line.setAttribute('y2', endY);
                line.setAttribute('stroke', '#ff0000'); line.setAttribute('stroke-width', '1');
                line.setAttribute('stroke-dasharray', '4, 2');
                svg.appendChild(line);
            }

            window.addEventListener('resize', () => svg.innerHTML = '');
        });
    </script>
</body>
</html>