<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solid Lab inc. | IMM Tracking System</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        .leaflet-interactive { transition: none !important; }
        /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è‰²ã®å¾®èª¿æ•´ */
        .status-tag.online { background: #28a745; color: white; }
        .status-tag.offline { background: #dc3545; color: white; }
    </style>
</head>
<body>

    <header>
        <h1>Solid Lab inc. <span>Injection Molding Machine Tracking</span></h1>
    </header>

    <main class="container">
        <section class="map-section">
            <div class="section-label">NATIONAL MONITORING MAP</div>
            <div id="map" class="japan-map-container"></div>
        </section>

        <section class="content-section">
            <div class="section-label">UNIT STATUS</div>
            
            <div id="initial-message" class="detail-box active">
                <h3>SELECT UNIT</h3>
                <p>åœ°å›³ä¸Šã®ãƒãƒ¼ã‚«ãƒ¼ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚</p>
            </div>

            <div id="detail-a" class="detail-box">
                <div class="unit-header"><span class="status-tag">LOADING...</span><h3>UNIT 01A</h3></div>
                <div class="data-grid">
                    <p><strong>æ‹ ç‚¹</strong> <span>tonakan1</span></p>
                    <p><strong>å ´æ‰€</strong> <span>ç¦äº•çœŒç¦äº•å¸‚</span></p>
                    <p><strong>ç¨¼åƒçŠ¶æ…‹</strong> <span class="val-status">--</span></p>
                    <p><strong>é›»æºæŠ•å…¥å›æ•°</strong> <span class="val-count">--</span></p>
                    <p><strong>æ¸©åº¦ãƒ‡ãƒ¼ã‚¿</strong> <span class="val-temp">--.-â„ƒ</span></p>
                </div>
            </div>

            <div id="detail-b" class="detail-box">
                <div class="unit-header"><span class="status-tag">LOADING...</span><h3>UNIT 02B</h3></div>
                <div class="data-grid">
                    <p><strong>æ‹ ç‚¹</strong> <span>tonakan2</span></p>
                    <p><strong>å ´æ‰€</strong> <span>ç¦äº•çœŒç¦äº•å¸‚</span></p>
                    <p><strong>ç¨¼åƒçŠ¶æ…‹</strong> <span class="val-status">--</span></p>
                    <p><strong>é›»æºæŠ•å…¥å›æ•°</strong> <span class="val-count">--</span></p>
                    <p><strong>æ¸©åº¦ãƒ‡ãƒ¼ã‚¿</strong> <span class="val-temp">--.-â„ƒ</span></p>
                </div>
            </div>
        </section>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const detailBoxes = document.querySelectorAll('.detail-box');
            let activeMarker = null;

            // åœ°å›³åˆæœŸåŒ–
            const map = L.map('map', { zoomControl: true, attributionControl: false }).setView([37.5, 137.5], 5);

            fetch("{{ url_for('static', filename='japan.geojson') }}")
                .then(res => res.json())
                .then(geoData => {
                    L.geoJSON(geoData, {
                        style: { color: "#000", weight: 0.5, fillColor: "#f0f0f0", fillOpacity: 1 }
                    }).addTo(map);
                });

            const deviceMapping = {
                "detail-a": { lat: 36.064, lng: 136.223, channelId: "2984916", readKey: "H8F1OIM9U1NLQE3M" },
                "detail-b": { lat: 35.900, lng: 136.150, channelId: "2874643", readKey: "3L8GCQ6QQRJD9R2R" }
            };

            Object.keys(deviceMapping).forEach(targetId => {
                const config = deviceMapping[targetId];
                const marker = L.circleMarker([config.lat, config.lng], {
                    radius: 4, fillColor: "#ff0000", color: "#ffffff", weight: 1, opacity: 1, fillOpacity: 1, pane: 'markerPane' 
                }).addTo(map);

                marker.on('click', async () => {
                    const targetZoom = map.getZoom() < 7 ? 8 : map.getZoom();
                    map.flyTo([config.lat, config.lng], targetZoom, { animate: true, duration: 0.8 });

                    if(activeMarker) { 
                        activeMarker.setRadius(4); 
                        activeMarker.setStyle({fillColor: "#ff0000", weight: 1}); 
                    }

                    setTimeout(() => {
                        marker.setRadius(6); 
                        marker.setStyle({fillColor: "#000000", weight: 2});
                        marker.bringToFront(); 
                        activeMarker = marker;
                    }, 800);

                    const targetDetail = document.getElementById(targetId);
                    detailBoxes.forEach(box => {
                        box.style.transition = 'none'; box.classList.remove('active'); box.style.display = 'none';
                    });

                    // ãƒ‡ãƒ¼ã‚¿æ›´æ–°ï¼ˆæ­»æ´»ç›£è¦–ãƒ­ã‚¸ãƒƒã‚¯å…¥ã‚Šï¼‰
                    await updateDeviceData(targetId, config);

                    if (targetDetail) {
                        setTimeout(() => {
                            targetDetail.style.display = 'block'; targetDetail.style.transition = '';
                            requestAnimationFrame(() => { targetDetail.classList.add('active'); });
                        }, 100);
                    }
                });
            });

            async function updateDeviceData(targetId, config) {
                const url = `https://api.thingspeak.com/channels/${config.channelId}/feeds.json?api_key=${config.readKey}&results=1`;
                try {
                    const res = await fetch(url);
                    const data = await res.json();
                    const latest = data.feeds[0];
                    const box = document.getElementById(targetId);
                    if (!latest || !box) return;

                    // --- ğŸ’¡ ä¿®æ­£ç‚¹ï¼šæ­»æ´»ç›£è¦–ãƒ­ã‚¸ãƒƒã‚¯ ---
                    const lastUpdate = new Date(latest.created_at);
                    const now = new Date();
                    // æœ€çµ‚æ›´æ–°ã‹ã‚‰ã®çµŒéæ™‚é–“ï¼ˆåˆ†ï¼‰ã‚’è¨ˆç®—
                    const diffMinutes = (now - lastUpdate) / 1000 / 60; 

                    // 2åˆ†ä»¥ä¸Šæ›´æ–°ãŒãªã‘ã‚Œã°ã€Œé€šä¿¡é€”çµ¶ï¼ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã€ã¨åˆ¤æ–­
                    const isTimeOut = diffMinutes > 2;
                    const isOnline = !isTimeOut && (latest.field2 === "1");
                    // --------------------------------

                    const statusTag = box.querySelector('.status-tag');
                    statusTag.textContent = isOnline ? "ONLINE" : "OFFLINE";
                    statusTag.className = `status-tag ${isOnline ? 'online' : 'offline'}`;
                    
                    // ç¨¼åƒçŠ¶æ…‹ã§ãªã‘ã‚Œã°ã€å„é …ç›®ã‚’åˆæœŸè¡¨ç¤º (-- ãªã©) ã«æˆ»ã™
                    box.querySelector('.val-status').textContent = isOnline ? "ç¨¼åƒä¸­" : "åœæ­¢ä¸­";
                    box.querySelector('.val-count').textContent = latest.field3 || "0";
                    
                    // åœæ­¢ä¸­ã®å ´åˆã¯æ¸©åº¦ã‚’ã€Œ--.-â„ƒã€ã«ã™ã‚‹ï¼ˆã”è¦æœ›ã®nanè¡¨ç¤ºã«è¿‘ã„å½¢ï¼‰
                    if (isOnline && latest.field1) {
                        box.querySelector('.val-temp').textContent = parseFloat(latest.field1).toFixed(1) + "â„ƒ";
                    } else {
                        box.querySelector('.val-temp').textContent = "--.-â„ƒ";
                    }

                } catch (e) { 
                    console.error("Data fetch error:", e);
                }
            }
        });
    </script>
</body>
</html>